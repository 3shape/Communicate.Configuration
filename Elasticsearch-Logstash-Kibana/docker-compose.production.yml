version: '2'

services:
    logstash:
        image: logstash
        command: logstash -e 'input { beats { port => 5044 }} filter { if [message] =~ /^#/ { drop{} } grok { match => { "message" => "(?<timestampIIS>%{YEAR}-%{MONTHNUM}-%{MONTHDAY} %{HOUR}:%{MINUTE}:%{SECOND}) \w+ \w+ %{IPV4:ip} (?<httpmethod>GET|POST|PUT|DELETE|OPTIONS|PATCH) %{URIPATH:url} (?<uriparam>[A-Za-z0-9'\''\$$.+!*|(){},~@#%&/=:;_?\-\[\]<>]*) .* (?<httpstatus>[0-9]{3}) \d+ \d+ \d+ \d+ %{INT:timetaken:int}" } match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} %{IPV4:ip} %{WORD:httpmethod} %{URIPATH:url} .* - %{INT:httpstatus:int} \d+ \d+ %{INT:timetaken:int}" } match => { "message" => "%{TIMESTAMP_ISO8601:timestamp}[\t](?<httpMethod>GET|POST)[\t]%{IPV4:requestIp}[\t]%{INT:size:int}[\t]%{INT:timetaken:int}" } match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} \w+ \w+ %{IPV4:ip} (?<httpmethod>GET|POST|PUT) %{URIPATH:url} .* (?<httpstatus>[0-9]{3}) \d+ \d+ \d+ \d+ %{INT:timetaken:int}" } match => { "message" => "%{TIMESTAMP_ISO8601:timestamp}[\t]%{WORD:CaseId}[\t]%{WORD:method}[\t]%{INT:timetaken:int}" } } date { match => ["timestampIIS", "YYYY-MM-dd HH:mm:ss", "ISO8601"] } date { match => ["timestamp", "YYYY-MM-dd HH:mm:ss", "ISO8601"] } } output { elasticsearch { hosts => ["es-client"] index => "%{type}-%{+YYYY.MM.dd}" } }'
