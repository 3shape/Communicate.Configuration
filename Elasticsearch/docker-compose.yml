version: '2'

services:
    es-master:
        image: elasticsearch:2
        restart: always
        command: sh -c 'echo "$$elasticsearch_yml" > config/elasticsearch.yml ; elasticsearch --discovery.zen.ping.multicast.enabled=false --discovery.zen.ping.unicast.hosts=es-master --discovery.zen.minimum_master_nodes=3 --node.master=true --node.data=false --cluster.name=production --node.name=es-master --network.bind_host=0.0.0.0'
        ulimits:
            memlock: -1
        networks:
        - elasticsearch-network
        environment:                                                                                                                                                                                                                                                                                        
        - reschedule=on-node-failure
        elasticsearch_yml: | bootstrap.mlockall: true
        labels:
        - 'com.docker.swarm.reschedule-policies=["on-node-failure"]'

    es-data:
        image: elasticsearch:2
        command: sh -c 'echo "$$elasticsearch_yml" > config/elasticsearch.yml ; elasticsearch --discovery.zen.ping.multicast.enabled=false --discovery.zen.ping.unicast.hosts=es-master --discovery.zen.minimum_master_nodes=3 --node.master=false --node.data=true --cluster.name=production --node.name=es-data'
        ulimits:
            memlock: -1
        restart: always
        depends_on:
            - es-master
        networks:
        - elasticsearch-network
        environment:
        - ES_HEAP_SIZE=4g
        elasticsearch_yml: | bootstrap.mlockall: true
        

    es-client:
        image: elasticsearch:2
        ports: 
         - "9200:9200"
        command: sh -c 'echo "$$elasticsearch_yml" > config/elasticsearch.yml ; elasticsearch --discovery.zen.ping.multicast.enabled=false --discovery.zen.ping.unicast.hosts=es-master --discovery.zen.minimum_master_nodes=3 --node.master=false --node.data=false --cluster.name=production --node.name=es-client'
        ulimits:
            memlock: -1
        restart: always
        depends_on:
            - es-master
        networks:
        - elasticsearch-network
        environment:
        elasticsearch_yml: | bootstrap.mlockall: true

networks:
  elasticsearch-network:
    driver: overlay